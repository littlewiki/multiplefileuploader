<project name="mfu-project" default="deploy" basedir=".">
    <description>
        mfu build file
    </description>
 
  <!-- set site credential --> 
  <property name="host"  value="${host}" />
  <property name="scpUser"  value="${user}" />
  <property name="scpPassword"  value="${password}" />
  <property name="remoteMfuDir"  value="" />
 
   <!-- set mfu dir-->  
  <property name="dojoVersion"  value="dojo-release-1.4.0-src" />
  <property name="dojoDir"  location="./${dojoVersion}/" />
  <property name="buildDir" location="${dojoDir}/util/buildscripts" /> 
  <property name="version" value="${version}" />
  
   <property name="mfuiddd" value="mfu-including-dijit-dojox-dependencies" />
   <property name="mfude" value="mfu-dojo-embedded" />
  
   <!-- set sphinx site local dir-->  
   <property name="sphinxBinDir" location="/usr/bin" />
   
   <property name="generateToDir" location="./target/website" />  

   <!-- set sphinx site remote dir-->  
   <property name="siteRemoteDir" value="public_html/sphinx" />
    <!-- set mfu site remote dir--> 
	<property name="mfuRemoteDir" value="public_html/mfu" />
	
	
   <property name="target_dir" value="${basedir}/target" />

  <target name="init">
    <mkdir dir="${target_dir}"/>
  </target>

  <target name="package" depends="init,build-mfu-dojo-embedded,build-mfu-including-dijit-dojox-dependencies, mfu-src-copy,mfu-dojo-embedded-copy,mfu-including-dijit-dojox-dependencies-copy,dojo-copy, pymager-conf-copy,replace-dojo-version,tar-release">
    <tstamp/>

  </target>

  <target name="replace-dojo-version">
  		<replace file="./build/multiplefileploader/${mfude}/${mfude}.html" token="@DOJO_VERSION@" value="${dojoVersion}"/>
  		<replace file="./build/multiplefileploader/${mfuiddd}/${mfuiddd}.html" token="@DOJO_VERSION@" value="${dojoVersion}"/>
		<replace file="./build/multiplefileploader/mfu-src/multiplefileuploader/mfu-src.html" token="@DOJO_VERSION@" value="${dojoVersion}"/>	
  </target>
  
  <target name="build-mfu-including-dijit-dojox-dependencies">
    <tstamp/>
    <exec dir="${buildDir}"
        executable="${buildDir}/build.sh">
          <arg value="profile=mfu-including-dijit-dojox-dependencies" />
          <arg value="action=clean,release" />
          <arg value="releaseName=mfu-including-dijit-dojox-dependencies" />
          <arg value="version=${version}" />
    </exec>

  </target>

  <target name="build-mfu-dojo-embedded">
    <exec dir="${buildDir}"
        executable="${buildDir}/build.sh">
          <arg value="profile=mfu-dojo-embedded" />
          <arg value="action=clean,release" />
          <arg value="releaseName=mfu-dojo-embedded" />
     	  <arg value="version=${version}" />
    </exec>
  </target>

  <target name="prepare-folder">
    <delete dir="./build"/>
	<mkdir dir="./build"/>
  </target>


  <target name="mfu-dojo-embedded-copy" depends="prepare-folder">
        <copy todir="./build/multiplefileploader/${mfude}/dojo/nls" overwrite="true">
                <fileset dir="${dojoDir}/release/${mfude}/dojo/nls"></fileset>
        </copy>
         <copy file="${dojoDir}/release/${mfude}/dojo/dojo.js" todir="./build/multiplefileploader/${mfude}/dojo"/>
         <copy file="${dojoDir}/release/${mfude}/dojo/dojo.js.uncompressed.js" todir="./build/multiplefileploader/${mfude}/dojo"/>
        <copy todir="./build/multiplefileploader/${mfude}/php" overwrite="true">
                <fileset dir="./multiplefileuploader/php"></fileset>
        </copy>
	    <copy file="${dojoDir}/release/${mfude}/multiplefileuploader/samples/${mfude}.html" todir="./build/multiplefileploader/${mfude}"/>
  </target>



 <target name="mfu-including-dijit-dojox-dependencies-copy" depends="prepare-folder">
	<copy todir="./build/multiplefileploader/${mfuiddd}/layers/nls" overwrite="true">
                <fileset dir="${dojoDir}/release/${mfuiddd}/layers/nls"></fileset>
    </copy>
     <copy file="${dojoDir}/release/${mfuiddd}/layers/mfu.js" todir="./build/multiplefileploader/${mfuiddd}/layers"/>
     <copy file="${dojoDir}/release/${mfuiddd}/layers/mfu.js.uncompressed.js" todir="./build/multiplefileploader/${mfuiddd}/layers"/>
     <copy file="${dojoDir}/release/${mfuiddd}/dojo/dojo.js" todir="./build/multiplefileploader/${mfuiddd}/dojo"/>
     <copy file="${dojoDir}/release/${mfuiddd}/dojo/dojo.js.uncompressed.js" todir="./build/multiplefileploader/${mfuiddd}/dojo"/>

    <copy todir="./build/multiplefileploader/${mfuiddd}/php" overwrite="true">
            <fileset dir="./multiplefileuploader/php"></fileset>
    </copy>
    <copy file="${dojoDir}/release/${mfuiddd}/multiplefileuploader/samples/${mfuiddd}.html" todir="./build/multiplefileploader/${mfuiddd}"/>	
</target>


  <target name="mfu-src-copy" depends="prepare-folder">
        <copy todir="./build/multiplefileploader/mfu-src/multiplefileuploader" overwrite="true">
                <fileset dir="./multiplefileuploader">
   				 <include name="**/*"/>  
	    		 <exclude name="**/samples/**"/> 
                </fileset>
        </copy>
	    <copy file="./multiplefileuploader/samples/mfu-src.html" todir="./build/multiplefileploader/mfu-src/multiplefileuploader"/>
  </target>
  
   <target name="dojo-copy" depends="prepare-folder,delete-release">
        <copy todir="./build/multiplefileploader/${dojoVersion}" overwrite="true">
                <fileset dir="${dojoDir}">
                </fileset>
        </copy>
  </target>
  
   <target name="pymager-conf-copy">
        <copy todir="./build/mfudemo" overwrite="true">
                <fileset dir="./mfudemo">
                </fileset>
        </copy>
  </target>  
  
  
    <target name="delete-release">
	    <delete dir="${dojoDir}/release" />
  </target>
  
   
  <target name="tar-release">
	<tar destfile="./mfu-${version}.tar" basedir="./build"/>
	<gzip destfile="./mfu-${version}.tar.gz" src="./mfu-${version}.tar"/>
	<delete file="./mfu-${version}.tar" />
  </target>


  <target name="deploy" depends="package">
	   <sshexec host="${host}"
			username="${scpUser}"
			password="${scpPassword}"
			command="mkdir -p ${mfuRemoteDir}"
	 /> 
	 
	  <scp file="./mfu-${version}.tar.gz" todir="${scpUser}:${scpPassword}@${host}:${mfuRemoteDir}" verbose="true">	  	
	  </scp>	
	  
	   <sshexec host="${host}"
			username="${scpUser}"
			password="${scpPassword}"
			command="cd ${mfuRemoteDir} ; tar -zvxf mfu-${version}.tar.gz"
	 /> 
	  
  </target>


  <target name="site" depends="init">
    <exec dir="${basedir}/website"
	    executable="python">
	      <arg value="${sphinxBinDir}/sphinx-build" />
          <arg value="-D" />
          <arg value="release=${version}" />
		  <arg value="-b" />
		  <arg value="html" />
		  <arg value="-d" />		  
		  <arg value="_build/doctrees" />
		  <arg value="." />		  
		  <arg value="${target_dir}/_build/html" />	  
    </exec>
  </target>

  <target name="site:deploy" depends="site" >
	   <sshexec host="${host}"
			username="${scpUser}"
			password="${scpPassword}"
			command="mkdir -p ${siteRemoteDir}"
	 /> 
	  <scp todir="${scpUser}:${scpPassword}@${host}:${siteRemoteDir}" verbose="true">
		<fileset dir="${target_dir}/_build/html"/>
	  </scp>
  </target>

  <target name="clean"
        description="clean up" >
    <delete dir="${build}"/>
    <delete dir="${dist}"/>
  </target>
  
  
</project>
