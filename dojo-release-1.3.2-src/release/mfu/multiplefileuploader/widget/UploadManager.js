/*
	Copyright (c) 2004-2009, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["multiplefileuploader.widget.UploadManager"]){dojo._hasResource["multiplefileuploader.widget.UploadManager"]=true;dojo.provide("multiplefileuploader.widget.UploadManager");dojo.require("multiplefileuploader.widget.IframeUploadStrategy");dojo.require("multiplefileuploader.widget.UploadStatusStrategy");dojo.require("multiplefileuploader.widget.ErrorCategorizer");dojo.require("dojox.collections.Queue");dojo.require("dojox.collections.ArrayList");dojo.declare("multiplefileuploader.widget.UploadManager",null,{constructor:function(_1,_2,_3){this._offline=false;this._statusLifeCycle=null;this._getStatusInterval=_3.getStatusInterval;this._progressbarMode=_3.progressBarMode;this._uploadStatusStrategy=new multiplefileuploader.widget.UploadStatusStrategy(_3);this._uploadQueue=new multiplefileuploader.widget._UploadQueue(this);this._statusLifeCycleFactory=new multiplefileuploader.widget._StatusLifeCycleFactory();this._lifeCycleFactory=new multiplefileuploader.widget._LifeCycleFactory();this._uploadStrategy=new multiplefileuploader.widget.IframeUploadStrategy(_2,_3);this._errorCategorizer=new multiplefileuploader.widget.ErrorCategorizer();dojo.mixin(this,_1);},addToUploadQueue:function(_4){this._uploadQueue.onImageUploadRequest(_4);_4.onUploadRequestEnqueued();if(!this._uploadQueue.isUploading()){this._processNextUpload();}},retryAllUploads:function(){this._offline=false;var _5=this._uploadQueue.getNextUploadRequest();_5.onRetry();this._processNextUpload();},_processNextUpload:function(){var _6=this._uploadQueue.getNextUploadRequest();if(_6!==null&&this._offline==false){if(_6.getAssociatedID()==null){this._getNewID(_6);}else{this._upload(_6);}}if(_6==null){this.onFinishedUploads();}},_getNewID:function(_7){this._statusLifeCycle=this._statusLifeCycleFactory.createStatusLifeCycle(_7);var _8={onIDSuccess:dojo.hitch(this,function(_9){this._statusLifeCycle._onGetIDComplete(_9);this._upload(_7);}),onIDError:dojo.hitch(this,function(_a){this._statusLifeCycle._onGetIDError(_a);})};this._uploadStatusStrategy.getID(_8);},_setupUploadMonitoring:function(_b){var _c=setInterval(dojo.hitch(this,function(){if(this._progressbarMode){var _d={onStatusSuccess:dojo.hitch(this,function(_e){this._statusLifeCycle._onStatusSuccess(_e);}),onStatusError:dojo.hitch(this,function(_f){this._statusLifeCycle._onStatusError(_f);})};this._uploadStatusStrategy.getStatus(_d,_b);}}),this._getStatusInterval);this._statusLifeCycle.saveMonitoringUploadHandler(_c);},_upload:function(_10){var _11=this._lifeCycleFactory.createLifeCycle(this,this._statusLifeCycle,_10);this._uploadQueue.onBeforeUploadStart(_10);_10.onBeforeUploadStart();this.fireProgress();var _12={onSuccess:function(_13,_14){_11._onUploadComplete(_13,_14);},onError:function(_15){_11._onRecoverableError(_15,"NETWORK_ERROR");}};this._uploadStrategy.upload(_12,_10);_11._onAfterUploadStart();this.onAfterUploadStart(_10);this._setupUploadMonitoring(_10);},_stopProcessingUploads:function(_16,_17){if(this._errorCategorizer.getErrorType(_17)==multiplefileuploader.widget.errorType.ERROR_TYPE_RECOVERABLE){this._offline=true;}this._uploadQueue.onUploadFailure(_16,_17);},_continueProcessingUploads:function(){this._uploadQueue.onUploadSuccess();},fireProgress:function(){var _18={numberUploadsInProgress:this._uploadQueue.getNumberUploadsInProgress(),pendingElements:this._uploadQueue.getPendingElements(),totalNumberOfUploadRequests:this._uploadQueue.getTotalNumberOfUploadRequests(),numberUploadFinished:this._uploadQueue.getNumberOfFinishedUploads(),filename:this._uploadQueue.getCurrentlyUploadingFilename()};this.onProgress(_18);},onFinishedUploads:function(){}});dojo.declare("multiplefileuploader.widget._LifeCycle",null,{constructor:function(_19,_1a,_1b,_1c){this._uploadManager=_1a;this._uploadRequest=_1c;this._statusLifeCycle=_1b;this._errorCategorizer=new multiplefileuploader.widget.ErrorCategorizer();dojo.mixin(this,_19);},_onUploadComplete:function(_1d,_1e){clearInterval(this._statusLifeCycle.getMonitoringUploadHandler());var _1f=null;try{if(_1d==null){this._onNonRecoverableError(_1d,"NULL_JSON_EXCEPTION");return;}var _1f=dojo.fromJson(_1d);}catch(e){this._onNonRecoverableError(_1d,"MALFORMED_JSON_EXCEPTION");return;}var _20=new multiplefileuploader.widget._UploadedFileInformation(_1f);if(_20.getStatus()=="KO"){this._dispatchError(_1d,_20);}else{this._uploadRequest.onUploadSuccess(_20,_1e);this._uploadManager.onFinishedUpload(_20);this._uploadManager._continueProcessingUploads();}},_onRecoverableError:function(_21,_22){clearInterval(this._statusLifeCycle.getMonitoringUploadHandler());this._uploadRequest.onUploadFailure(_21,_22);this._uploadManager._stopProcessingUploads(this._uploadRequest,_22);},_onNonRecoverableError:function(_23,_24){this._uploadRequest.onUploadFailure(_23,_24);this._uploadManager._continueProcessingUploads();},_onAfterUploadStart:function(){this._uploadRequest.onAfterUploadStart();},_dispatchError:function(_25,_26){switch(this._errorCategorizer.getErrorType(_26.getErrorCode())){case multiplefileuploader.widget.errorType.ERROR_TYPE_RECOVERABLE:this._onRecoverableError(_25,_26.getErrorCode());break;case multiplefileuploader.widget.errorType.ERROR_TYPE_NON_RECOVERABLE:this._onNonRecoverableError(_25,_26.getErrorCode());break;default:throw "UNKNOWN EXCEPTION";break;}}});dojo.declare("multiplefileuploader.widget._LifeCycleFactory",null,{constructor:function(){},createLifeCycle:function(_27,_28,_29){return new multiplefileuploader.widget._LifeCycle({},_27,_28,_29);}});dojo.declare("multiplefileuploader.widget._StatusLifeCycleFactory",null,{constructor:function(){},createStatusLifeCycle:function(_2a){return new multiplefileuploader.widget._StatusLifeCycle({},_2a);}});dojo.declare("multiplefileuploader.widget._StatusLifeCycle",null,{constructor:function(_2b,_2c){this._uploadRequest=_2c;this._currentIDInformation=null;this._monitoringUploadHandler=null;dojo.mixin(this,_2b);},getMonitoringUploadHandler:function(){return this._monitoringUploadHandler;},saveMonitoringUploadHandler:function(_2d){this._monitoringUploadHandler=_2d;},_onGetIDComplete:function(_2e){this._currentIDInformation=new multiplefileuploader.widget._IDInformation(dojo.fromJson(_2e));this._uploadRequest.setAssociatedID(this._currentIDInformation.getID());},_onGetIDError:function(_2f){this._currentIDInformation=new multiplefileuploader.widget._IDInformation(dojo.fromJson(_2f));},_onStatusSuccess:function(_30){var _31=new multiplefileuploader.widget._StatusInformation(dojo.fromJson(_30));this._uploadRequest.onStatusSuccess(_31);},_onStatusError:function(_32){clearInterval(this._monitoringUploadHandler);var _33=new multiplefileuploader.widget._StatusInformation(dojo.fromJson(_32));this._uploadRequest.onStatusError(_33);},getCurrentIDInformation:function(){return this._currentIDInformation;}});dojo.declare("multiplefileuploader.widget._IDInformation",null,{constructor:function(_34){this._data=_34;},getID:function(){return this._data.id;}});dojo.declare("multiplefileuploader.widget._StatusInformation",null,{constructor:function(_35){this._data=_35;},getID:function(){return this._data.id;},getUploadedSize:function(){return this._data.complete;},getTotalSize:function(){return this._data.total;}});dojo.declare("multiplefileuploader.widget.FileUploadRequestMixin",null,{constructor:function(){},onBeforeUploadStart:function(){this._doOnBeforeUploadStart();},onAfterUploadStart:function(){this._doOnAfterUploadStart();},onUploadSuccess:function(_36,_37){this._doOnUploadSuccess(_36,_37);},onUploadFailure:function(_38,_39){this._doOnUploadFailure(_38,_39);},onRetry:function(){this._doOnRetry();},onUploadRequestEnqueued:function(){this._doOnUploadRequestEnqueued();},getUploadingFilename:function(){return this._doGetUploadingFilename();},getFileInput:function(){return this._doGetFileInput();},setAssociatedID:function(_3a){this._doSetAssociatedID(_3a);},getAssociatedID:function(){return this._doGetAssociatedID();},onStatusSuccess:function(_3b){this._doOnStatusSuccess(_3b);},onStatusError:function(_3c){this._doOnStatusError(_3c);}});dojo.declare("multiplefileuploader.widget._UploadedFileInformation",null,{constructor:function(_3d){this._data=_3d;},getName:function(){return this._data.name;},getMimeType:function(){return this._data.mimetype;},getSize:function(){return this._data.size;},getStatus:function(){return this._data.status;},getErrorCode:function(){return this._data.errorcode;},getID:function(){return this._data.id;}});dojo.declare("multiplefileuploader.widget._UploadQueue",null,{constructor:function(_3e){this.uploadManager=_3e;this._filesInQueue=new dojox.collections.Queue([]);this._currentUploadRequest=null;this._uploadFinished=0;this._uploading=false;this._totalNumberOfUploadRequests=0;this._errorCategorizer=new multiplefileuploader.widget.ErrorCategorizer();},onImageUploadRequest:function(_3f){this._filesInQueue.enqueue(_3f);this._totalNumberOfUploadRequests++;},onBeforeUploadStart:function(_40){this._currentUploadRequest=_40;this._filesInQueue.dequeue(_40);this._uploading=true;},onUploadSuccess:function(){this._uploading=false;this._uploadFinished++;this.uploadManager._processNextUpload();},onUploadFailure:function(_41,_42){this._uploading=false;if(this._errorCategorizer.getErrorType(_42)==multiplefileuploader.widget.errorType.ERROR_TYPE_RECOVERABLE){this._enqueueAtBegining(_41);}},getTotalNumberOfUploadRequests:function(){return this._totalNumberOfUploadRequests;},getNumberOfFinishedUploads:function(){return this._uploadFinished;},getNumberUploadsInProgress:function(){return this.getTotalNumberOfUploadRequests()-this.getNumberOfFinishedUploads();},getPendingElements:function(){return this._filesInQueue.toArray();},isUploading:function(){return this._uploading;},getNextUploadRequest:function(){if(!this.isUploading()&&this._filesInQueue.count>0){return this._filesInQueue.peek();}else{return null;}},getCurrentlyUploadingFilename:function(){return this._currentUploadRequest.getUploadingFilename();},_enqueueAtBegining:function(_43){var q=new dojox.collections.Queue([]);q.enqueue(_43);dojo.forEach(this._filesInQueue.toArray(),function(elt){q.enqueue(elt);});this._filesInQueue=q;}});}